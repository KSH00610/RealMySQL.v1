# 5.2 MySQL 엔진의 잠금

MySQL에서 사용되는 잠금은 크게 스토리지 엔진 레벨과 MySQL 엔진 레벨로 나눌 수 있다. MySQL 엔진 레벨의 잠금은 모든 스토리지 엔진에 영향을 미치지만, 스토리지 엔진 레벨의 잠금은 스토리지 엔진 간 상호 영향을 미치지 않는다.

MySQL 엔진 레벨 잠금의 주요 종류로는 **글로벌 락**, **테이블 락**, **네임드 락**, 그리고 **메타데이터 락**이 있다.

## 5.2.1 글로벌 락

글로벌 락은 MySQL이 제공하는 잠금 가운데 가장 범위가 크다. 한 세션에서 글로벌 락을 획득하면 다른 세션에서 `SELECT`를 제외한 대부분의 DDL 및 DML 문장을 실행할 수 없게 된다. 글로벌 락이 해제될 때까지 해당 문장은 대기 상태로 남는다.

- **영향 범위:**  
  글로벌 락은 MySQL 서버 전체에 영향을 미친다. 작업 대상 테이블이나 데이터베이스가 다르더라도 동일하게 적용된다.  
  예를 들어, 여러 데이터베이스에 걸쳐 MyISAM 또는 MEMORY 테이블의 일관된 백업을 수행하려면 글로벌 락을 사용해야 한다. 하지만 InnoDB가 일반화되면서 이 락은 효율성 문제로 인해 거의 사용되지 않게 되었다.

- **InnoDB와 글로벌 락:**  
  InnoDB는 기본적으로 트랜잭션을 지원하므로, 일관된 데이터 상태를 유지하기 위해 모든 데이터 변경을 멈출 필요가 없다. 따라서 글로벌 락 대신 보다 효율적인 백업 락이 등장했다.

- **백업 락 (Backup Lock):**  
  MySQL 8.0부터 도입된 백업 락은 특정 세션에서 획득하면 다른 세션이 다음과 같은 작업을 수행하지 못하도록 제한한다:
  - 데이터베이스, 테이블 등의 생성, 변경, 삭제
  - `REPAIR TABLE`, `OPTIMIZE TABLE` 명령
  - 사용자 관리 및 비밀번호 변경  
    백업 락은 일반적인 테이블 데이터 변경은 허용하며, 레플리카 서버에서 백업을 실행할 때 복제 지연을 최소화하는 데 유용하다.

## 5.2.2 테이블 락

테이블 락은 특정 테이블 단위로 설정되는 잠금이다. 테이블 락은 **명시적**으로 요청하거나, **묵시적**으로 설정될 수 있다.

- **명시적 테이블 락:**  
  `LOCK TABLES table_name [READ | WRITE]`를 통해 특정 테이블에 대해 명시적으로 락을 걸 수 있다.  
  명시적 테이블 락을 설정하면 해당 락을 명시적으로 해제해야 한다: `UNLOCK TABLES`.  
  하지만 글로벌 락과 마찬가지로 온라인 작업에 심각한 영향을 줄 수 있으므로 특별한 경우가 아니면 사용하지 않는다.

- **묵시적 테이블 락:**  
  MyISAM이나 MEMORY 테이블의 데이터를 변경하는 쿼리를 실행할 때, 해당 쿼리가 실행되는 동안 자동으로 테이블 락을 획득하고 완료되면 해제한다.  
  InnoDB의 경우 기본적으로 레코드 기반 잠금을 사용하기 때문에 단순 데이터 변경 쿼리에서는 묵시적 테이블 락이 발생하지 않는다. 다만, 정확히 말하자면 InnoDB 테이블에도 테이블 락은 설정되지만 DML 쿼리에서는 무시되며 DDL의 경우에만 영향을 미친다.

## 5.2.3 네임드 락

네임드 락(named lock)은 `GET_LOCK()` 함수를 통해 사용자가 정의한 문자열에 대해 잠금을 설정하는 기능이다.

- **특징:**  
  네임드 락은 테이블이나 레코드에 잠금을 거는 대신 임의의 문자열에 잠금을 건다.  
  여러 클라이언트 간 동기화가 필요할 때 유용하다. 예를 들어, 같은 테이블이나 레코드에 대해 서로 다른 작업에 대해 각기 다른 이름으로 잠금을 걸 수 있다.  
  복잡한 요건으로 많은 레코드를 변경해야 하는 트랜잭션에서 유용하게 사용할 수 있다.

## 5.2.4 메타데이터 락

메타데이터 락(metadata lock)은 테이블, 뷰 등의 데이터베이스 객체 이름이나 구조를 변경하는 경우에 사용된다.  
예를 들어, `ALTER TABLE`이나 `DROP TABLE` 같은 작업을 수행할 때 메타데이터 락을 통해 데이터베이스 객체가 다른 작업으로 인해 변하지 않도록 보호한다.
