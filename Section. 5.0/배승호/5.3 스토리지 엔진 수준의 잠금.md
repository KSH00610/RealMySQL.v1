# 스토리지 엔진 수준의 락의 종류

MySQL에서 사용되는 락은 크게 스토리지 엔진 레벨과 MySQL 엔진 레벨로 나눌 수 있다. 스토리지 엔진 레벨의 잠금은 테이블의 데이터를 다루기 위한 락이며, MySQL 엔진 레벨의 잠금은 테이블이나 데이터베이스 등과 같은 부분을 위한 락에 해당한다. 여기서는 스토리지 엔진 레벨의 잠금에 대해 설명한다.

## 레코드 락(Record Lock)

일반적으로 레코드 락은 테이블 레코드 자체를 잠그는 락을 의미한다. 그러나 MySQL에서는 테이블의 레코드가 아닌 인덱스의 레코드를 잠근다는 점에서 다른 DBMS와 차이가 있다. 인덱스는 테이블과 별도의 자료구조로 관리되기 때문에, MySQL의 레코드 락은 클러스터 인덱스(PK)와 논클러스터 인덱스(세컨더리 인덱스) 모두를 포함한다. PK가 없는 경우, 내부적으로 자동 생성된 PK를 통해 잠금이 걸린다.

인덱스 레코드에 잠금을 거는 것과 테이블 레코드에 잠금을 거는 것은 큰 차이가 있다. 예를 들어, `member` 테이블에서 `last_name`이 J로 시작하는 구성원이 300명 있다고 가정하자. 그리고 `first_name`이 MangKyu인 사원이 1명만 존재한다고 하자. 이때, `last_name`에만 인덱스가 걸려 있는 경우 `last_name`이 J로 시작하며 `first_name`이 MangKyu인 구성원의 등록일을 변경하는 UPDATE 쿼리를 실행하면, 영향받는 레코드는 1건이지만, MySQL은 300건의 인덱스 레코드에 잠금을 건다. 이는 MySQL이 테이블 레코드가 아닌 인덱스에 잠금을 걸기 때문이다.

만약 적절한 인덱스가 없다면 모든 테이블의 레코드에 락을 걸고, 테이블을 풀스캔하면서 작업을 처리하게 된다. 이러한 구조는 동시성을 크게 떨어뜨리므로, MySQL에서 인덱스 설계는 매우 중요하다. 레코드 락은 트랜잭션이 DML 구문을 실행할 때 자동으로 설정되며, 이를 통해 여러 트랜잭션이 동시에 서로 다른 레코드에 접근할 수 있다.

## 갭 락(Gap Lock)

갭 락은 레코드가 아닌 레코드와 레코드 사이의 간격에 잠금을 걸어 레코드의 생성, 수정 및 삭제를 제어한다. 예를 들어, 성이 J로 시작하는 레코드가 `Jo`, `Joe` 두 개 있다고 하자. 이때, 다른 데이터가 추가되지 않도록 갭 락을 설정하면, 임의의 데이터가 추가되지 않는다.  
SELECT ... FOR UPDATE 구문은 쓰기 잠금(베타적 잠금)을, LOCK IN SHARE MODE는 읽기 잠금(공유락)을 의미한다. 이 락은 트랜잭션이 커밋 또는 롤백될 때 해제된다.

갭 락은 인덱스 범위 조건 중 실제 레코드를 제외하고 데이터가 추가될 수 있는 공간에 걸린다. 예를 들어, `num` 테이블에 2, 3이라는 인덱스 레코드가 있다면, 현존하는 레코드인 2와 3에 걸리는 락이 레코드 락이고, 아직 실존하지 않는 1과 4, 5가 추가될 수 있는 공간에 걸리는 락이 갭 락이다.  
즉, 갭 락은 아직 존재하지 않지만, 지정된 범위에 해당하는 인덱스 테이블 공간을 대상으로 걸리는 잠금이다. 갭 락은 특히 프라이머리 키(PK)나 유니크 인덱스에 의한 작업에서는 사용되지 않는다. 이 잠금은 팬텀 읽기를 방지하는 데 유용하다.

## 넥스트 키 락(Next Key Lock)

넥스트 키 락은 레코드 락과 갭 락을 합친 잠금이다. 갭 락은 일반적으로 넥스트 키 락의 일부로 함께 사용된다.  
넥스트 키 락이나 갭 락은 바이너리 로그가 리플리카 서버에서 동일한 결과를 만들어 내도록 보장하는 것이 주목적이다. 다만, 넥스트 키 락과 갭 락으로 인해 데드락이 발생하거나 다른 트랜잭션이 기다리는 일이 자주 발생할 수 있다. 이런 상황에서는 바이너리 로그 포맷을 ROW 형태로 바꾸어 넥스트 키 락이나 갭 락을 줄이는 것이 권장된다.

## 자동 증가 락(Auto Increment Lock)

MySQL은 자동 증가하는 숫자 값을 채번하기 위해 AUTO_INCREMENT 속성을 제공한다. 이는 새로운 레코드가 삽입될 때 중복되지 않고 순차적으로 증가하는 일련번호를 보장한다.  
자동 증가 락은 INSERT와 REPLACE 쿼리에서만 사용되며, 트랜잭션과 관계없이 작동한다. 락이 걸리는 순간은 AUTO_INCREMENT 값을 가져오는 때이며, 락은 짧은 시간 동안만 걸렸다가 바로 해제된다.  
자동 증가 락은 값이 증가하면 줄어들지 않으며, 트랜잭션이 롤백되더라도 복구되지 않는다. 이를 초기화하려면 ALTER TABLE 문을 사용해야 한다.  
예: `ALTER TABLE tablename AUTO_INCREMENT = 1`
